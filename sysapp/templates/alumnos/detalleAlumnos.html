{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ alumno.nombre_completo }} - ITS CEP{% endblock %}
{% block page_title %}Detalle del Alumno{% endblock %}

{% block extra_css %}
<style>
    .alumno-header {
        background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
        color: white;
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
    }
    .info-label {
        color: var(--text-muted);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }
    .puntos-estrellas {
        display: flex;
        gap: 0.5rem;
    }
    .info-value {
        font-weight: 600;
        color: var(--text-main);
    }
    .info-value-white {
        font-weight: 600;
        color: white;
    }
    .star-badge {
        background: rgba(255, 243, 205, 0.1);
        color: #ffc107;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        display: inline-flex;
        align-items: center;
        font-weight: 700;
        border: 1px solid rgba(255, 238, 186, 0.2);
    }
    [data-theme="dark"] .star-badge {
        background: rgba(255, 193, 7, 0.15);
        color: #ffc107;
        border-color: rgba(255, 193, 7, 0.3);
    }
    [data-theme="light"] .star-badge {
        background: #fff3cd;
        color: #856404;
        border-color: #ffeeba;
    }
    .section-card {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        height: 100%;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        color: var(--text-main);
    }
    .nav-pills .nav-link {
        border-radius: 50px;
        padding: 0.5rem 1.25rem;
        color: var(--text-muted);
        font-weight: 500;
    }
    .nav-pills .nav-link.active {
        background-color: var(--primary-500);
    }
    [data-theme="dark"] .badge.border {
        background-color: #0f172a !important;
        border-color: #334155 !important;
        color: var(--gray-600) !important;
    }

    [data-theme="dark"] .table-hover tbody tr:hover {
        background-color: rgba(148, 163, 184, 0.1) !important;
    }
    [data-theme="dark"] .alert-danger{
        background-color: rgba(113, 28, 35, 0.68);
        border-color: #f5c6cb;
        color: #f8d7da;

    }

    /* Estilos para tablas responsivas en móviles */
    @media (max-width: 768px) {
        .alumno-header {
            padding: 1.5rem;
            text-align: center;
        }
        .alumno-header .d-flex.align-items-center {
            flex-direction: column;
        }
        .alumno-header .rounded-circle {
            margin-right: 0 !important;
            margin-bottom: 1rem;
        }
        .alumno-header .d-flex.flex-wrap {
            justify-content: center;
        }
        .alumno-header .star-badge {
            width: 100%;
            justify-content: center;
        }
        .alumno-header .d-flex.justify-content-md-end {
            justify-content: center;
            width: 100%;
            gap: 0.5rem !important;
        }
        .alumno-header .btn {
            flex: 1;
            padding: 0.6rem 0.4rem;
            font-size: 0.75rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .alumno-header .btn i {
            margin-right: 2px !important;
        }

        /* Tabs lado a lado en móvil */
        .nav-pills {
            flex-wrap: nowrap !important;
            overflow-x: auto;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .nav-pills .nav-item {
            flex: 1;
        }
        .nav-pills .nav-link {
            padding: 0.5rem 0.5rem;
            font-size: 0.85rem;
            text-align: center;
            white-space: nowrap;
        }
        .nav-pills .nav-link i {
            display: none; /* Ocultar iconos en tabs para ahorrar espacio en móvil */
        }

        .table-responsive-stack thead {
            display: none;
        }
        .table-responsive-stack tr {
            display: block;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            border-radius: var(--border-radius-md);
            padding: 0.5rem;
            background: var(--card-bg);
        }
        .table-responsive-stack td {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0.75rem !important;
            border-bottom: 1px solid var(--border-color);
            text-align: right !important;
        }
        .table-responsive-stack td:last-child {
            border-bottom: none;
        }
        .table-responsive-stack td::before {
            content: attr(data-label);
            font-weight: 700;
            text-align: left;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-right: 1rem;
        }
        
        /* Ajustes específicos para las estrellas en móvil */
        .puntos-estrellas {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            max-width: 150px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header del Alumno -->
<div class="alumno-header mt-5">
    <div class="row align-items-center">
        <div class="col-md-7">
            <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle p-3 me-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; background-color: rgba(255,255,255,0.2);">
                    <i class="bi bi-person-fill text-white" style="font-size: 2.5rem;"></i>
                </div>
                <div>
                    <h2 class="mb-0 fw-bold text-white">{{ alumno.nombre_completo }}</h2>
                    <p class="mb-0 text-white-50"><i class="bi bi-mortarboard-fill me-1"></i> {{ alumno.carrera.nombre }}</p>
                </div>
            </div>
            <div class="d-flex flex-wrap gap-4 mt-3">
                <div>
                    <div class="small opacity-75">Cédula</div>
                    <div class="fw-bold">{{ alumno.cedula }}</div>
                </div>
                <div>
                    <div class="small opacity-75">Sede</div>
                    <div class="fw-bold">{{ alumno.sede.nombre }}</div>
                </div>
                <div>
                    <div class="small opacity-75">Estado</div>
                    {% if alumno.activo %}
                        <span class="badge bg-success">Activo</span>
                    {% else %}
                        <span class="badge bg-danger">Inactivo</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-5 text-md-end mt-4 mt-md-0">
            <div class="star-badge mb-3">
                <i class="bi bi-star-fill text-warning me-2"></i>
                <span class="fs-4">{{ total_estrellas }}</span>
                <span class="ms-2">Puntos</span>
            </div>
            <div class="d-flex justify-content-md-end gap-2">
                <a href="{% url 'editar_alumno' alumno.uuid %}" class="btn btn-light btn-sm rounded-pill px-3">
                    <i class="bi bi-pencil me-1"></i> Editar
                </a>
                <a href="{% url 'registrar_pago' %}?alumno={{ alumno.id }}&sede={{ alumno.sede.id }}&carrera={{ alumno.carrera.id }}&nombre={{ alumno.nombre_completo|urlencode }}" class="btn btn-success btn-sm rounded-pill px-3">
                    <i class="bi bi-cash-stack me-1"></i> Cobrar
                </a>
                <button type="button" class="btn btn-warning btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#modalCanje">
                    <i class="bi bi-gift me-1"></i> Canjear
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Información Personal -->
    <div class="col-md-8">
        <div class="section-card">
            <h5 class="mb-4 d-flex align-items-center">
                <i class="bi bi-info-circle-fill text-primary me-2"></i>
                Información Detallada
            </h5>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="info-label">Fecha de Nacimiento</div>
                        <div class="info-value">{{ alumno.fecha_nacimiento|date:"d M, Y" }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="info-label">Teléfono</div>
                        <div class="info-value">{{ alumno.telefono }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="info-label">Curso Actual</div>
                        <div class="info-value">{{ alumno.curso_actual }}º Año</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="info-label">Fecha de Inicio</div>
                        <div class="info-value">{{ alumno.fecha_inicio|date:"d M, Y" }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="info-label">Carrera Naturalidad</div>
                        <div class="info-value">{{ alumno.carrera.get_naturalidad_display }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="info-label">Fecha de Registro</div>
                        <div class="info-value small">{{ alumno.fecha_registro|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                <div class="col-12">
                    <hr class="text-muted opacity-25">
                    <h6 class="mb-3 text-primary">Contacto de Emergencia</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="info-label">Nombre</div>
                            <div class="info-value">{{ alumno.contacto_emergencia_nombre }}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-label">Teléfono</div>
                            <div class="info-value">{{ alumno.contacto_emergencia_telefono }}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-label">Relación</div>
                            <div class="info-value">{{ alumno.contacto_emergencia_relacion }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado Financiero -->
    <div class="col-md-4">
        <div class="section-card">
            <h5 class="mb-4 d-flex align-items-center">
                <i class="bi bi-wallet2 text-primary me-2"></i>
                Estado Financiero
            </h5>
            
            <div class="mb-4">
                <div class="info-label">Situación de Pagos</div>
                {% if alumno.estado_pagos == 'AL_DIA' %}
                    <div class="alert alert-success d-flex align-items-center border-0 shadow-sm py-2">
                        <i class="bi bi-check-circle-fill me-2"></i> Al día
                    </div>
                {% elif alumno.estado_pagos == 'CERCANO_VENCIMIENTO' %}
                    <div class="alert alert-warning d-flex align-items-center border-0 shadow-sm py-2">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> Próximo a vencer
                    </div>
                {% elif alumno.estado_pagos == 'ATRASADO' %}
                    <div class="alert alert-danger d-flex align-items-center border-0 shadow-sm py-2">
                        <i class="bi bi-x-circle-fill me-2"></i> Atrasado
                    </div>
                {% else %}
                    <div class="alert alert-secondary d-flex align-items-center border-0 shadow-sm py-2">
                        <i class="bi bi-info-circle-fill me-2"></i> Sin pagos
                    </div>
                {% endif %}
            </div>

            <div class="mb-3">
                <div class="info-label">Total Pagado</div>
                <div class="h4 fw-bold text-success mb-0">Gs. {{ total_pagado|formato_guaranies }}</div>
            </div>

            {% if alumno.carrera.naturalidad == 'TS' %}
                <div class="mt-4 p-3 rounded-3 border" style="background-color: var(--gray-100);">
                    <div class="info-label mb-2">Habilitación de Examen</div>
                    {% if alumno.puede_rendir_examen %}
                        <div class="text-success fw-bold">Habilitado</div>
                    {% else %}
                        <div class="text-danger fw-bold">No Habilitado</div>
                        <small>Debe estar al día con sus cuotas</small>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tabs de Movimientos -->
<div class="section-card mb-4">
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-pagos-tab" data-bs-toggle="pill" data-bs-target="#pills-pagos" type="button" role="tab">
                <i class="bi bi-cash me-1"></i> <span class="d-none d-sm-inline">Historial de Pagos</span><span class="d-inline d-sm-none">Historial</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-canjes-tab" data-bs-toggle="pill" data-bs-target="#pills-canjes" type="button" role="tab">
                <i class="bi bi-gift me-1"></i> <span class="d-none d-sm-inline">Canjes Realizados</span><span class="d-inline d-sm-none">Canjes</span>
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="pills-tabContent">
        <!-- Panel de Pagos -->
        <div class="tab-pane fade show active" id="pills-pagos" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover align-middle table-responsive-stack">
                    <thead>
                        <tr>
                            <th>Recibo</th>
                            <th>Fecha</th>
                            <th>Cuota</th>
                            <th>Concepto</th>
                            <th class="text-end">Importe</th>
                            <th class="text-center">Puntos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in pagos %}
                        <tr onclick="window.location='{% url 'detalle_pago' pago.uuid %}'">
                            <td data-label="Recibo"><span class="badge border" style="background-color: var(--gray-100); color: var(--text-main);">{% if pago.numero_recibo %}{{ pago.numero_recibo }}{% else %}Sin recibo{% endif %}</span></td>
                            <td data-label="Fecha">{{ pago.fecha|date:"d/m/Y" }}</td>
                            <td data-label="Cuota">{{ pago.numero_cuota }}</td>
                            <td data-label="Concepto">{{ pago.concepto|truncatechars:40 }}</td>
                            <td data-label="Importe" class="text-end fw-bold">Gs. {{ pago.importe_total|formato_guaranies }}</td>
                            <td data-label="Puntos" class="text-center">
                                {% if pago.estrellas > 0 %}
                                    <div class="puntos-estrellas">
                                        {% for i in "x"|ljust:pago.estrellas %}⭐{% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No hay pagos registrados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Panel de Canjes -->
        <div class="tab-pane fade" id="pills-canjes" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover align-middle table-responsive-stack">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Concepto</th>
                            <th class="text-center">Cantidad</th>
                            <th>Registrado por</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for canje in canjes %}
                        <tr>
                            <td data-label="Fecha">{{ canje.fecha|date:"d/m/Y H:i" }}</td>
                            <td data-label="Concepto">{{ canje.concepto }}</td>
                            <td data-label="Cantidad" class="text-center fw-bold text-danger">-{{ canje.cantidad }} ⭐</td>
                            <td data-label="Registrado por">{{ canje.usuario_registro.get_full_name|default:canje.usuario_registro.username }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-5 text-muted">
                                <i class="bi bi-gift fs-1 d-block mb-2"></i>
                                No hay canjes registrados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="mt-4 mb-5">
    <a href="{% url 'lista_alumnos' %}" class="btn btn-outline-secondary rounded-pill">
        <i class="bi bi-arrow-left me-1"></i> Volver a la lista
    </a>
</div>

<!-- Modal de Canje -->
<div class="modal fade" id="modalCanje" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-gift-fill me-2"></i> Registrar canje</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'canjear_estrellas' alumno.uuid %}" method="POST">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <div class="display-6 fw-bold text-warning">⭐ {{ total_estrellas }}</div>
                        <div class="text-muted">Puntos disponibles</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cantidad a Canjear</label>
                        <input type="number" name="cantidad" class="form-control form-control-lg" min="1" max="{{ total_estrellas }}" required placeholder="0">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Concepto / Premio</label>
                        <input type="text" name="concepto" class="form-control" required placeholder="Ej: Vale de fotocopias, Kit de dibujo...">
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning rounded-pill px-4 fw-bold">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
