{% extends 'base.html' %}
{% load static %}
{% block title %}{{ titulo }} - ITS CEP{% endblock %}
{% block page_title %}{{ titulo }}{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
        --primary: #2563eb; --primary-dark: #1d4ed8; --primary-light: #3b82f6; --primary-soft: #dbeafe;
        --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
        --gray-400: #9ca3af; --gray-500: #6b7280; --gray-600: #4b5563; --gray-700: #374151;
        --gray-800: #1f2937; --gray-900: #111827;
        --success: #10b981; --success-light: #d1fae5; --error: #ef4444;
        --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,.05); --shadow-md: 0 4px 6px -1px rgba(0,0,0,.1);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
        --font-sans: 'Inter', -apple-system, sans-serif;
    }
    [data-theme="dark"] {
        --primary: #3b82f6; --primary-dark: #2563eb; --primary-soft: #1e293b;
        --gray-50: #111827; --gray-100: #1f2937; --gray-200: #374151; --gray-300: #4b5563;
        --gray-400: #6b7280; --gray-500: #9ca3af; --gray-600: #d1d5db; --gray-700: #e5e7eb;
        --gray-800: #f3f4f6; --gray-900: #f9fafb; --success-light: #064e3b;
    }

    .pf { font-family: var(--font-sans); color: var(--gray-800); padding: 2rem 1.5rem; }
    .pf-shell { max-width: 860px; margin: 0 auto; }

    /* Header */
    .pf-header {
        background: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        padding: 1.5rem 2rem; border-bottom: 1px solid var(--gray-200);
        display: flex; align-items: center; justify-content: space-between;
    }
    [data-theme="dark"] .pf-header { background: var(--gray-50); }
    .pf-header-left { display: flex; align-items: center; gap: 1rem; }
    .pf-header-icon {
        width: 48px; height: 48px; background: var(--primary-soft);
        border-radius: var(--radius-md); display: flex; align-items: center;
        justify-content: center; color: var(--primary); font-size: 1.5rem;
    }
    .pf-header-title h1 { font-size: 1.5rem; font-weight: 700; margin: 0 0 .25rem; color: var(--gray-900); }
    .pf-header-title p  { margin: 0; font-size: .875rem; color: var(--gray-500); }

    /* Body */
    .pf-body { background: white; border-radius: 0 0 var(--radius-lg) var(--radius-lg); box-shadow: var(--shadow-lg); overflow: hidden; }
    [data-theme="dark"] .pf-body { background: var(--gray-50); }

    /* Section */
    .pf-section { padding: 2rem; border-bottom: 1px solid var(--gray-200); animation: slideIn .3s ease both; }
    .pf-section:last-child { border-bottom: none; }
    .pf-section:hover { background-color: var(--gray-50); }
    [data-theme="dark"] .pf-section:hover { background: transparent; }
    @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .pf-section:nth-child(1) { animation-delay:.05s; }
    .pf-section:nth-child(2) { animation-delay:.1s; }
    .pf-section:nth-child(3) { animation-delay:.15s; }
    .pf-section:nth-child(4) { animation-delay:.2s; }

    .pf-section-header { display:flex; align-items:flex-start; gap:1rem; margin-bottom:1.5rem; }
    .pf-section-number {
        width:32px; height:32px; min-width:32px; background:var(--primary-soft);
        border-radius:50%; display:flex; align-items:center; justify-content:center;
        font-weight:700; color:var(--primary); font-size:.875rem;
    }
    .pf-section-header h2 { font-size:1.125rem; font-weight:600; margin:0; color:var(--gray-900); }
    .pf-section-header p  { margin:.25rem 0 0; font-size:.875rem; color:var(--gray-500); }

    /* Grid */
    .pf-grid { display:grid; gap:1.5rem; }
    .pf-grid-2 { grid-template-columns:repeat(2,1fr); }
    .pf-grid-3 { grid-template-columns:repeat(3,1fr); }
    @media(max-width:768px) { .pf-grid-2,.pf-grid-3 { grid-template-columns:1fr; } }

    /* Fields */
    .pf-field { display:flex; flex-direction:column; gap:.5rem; }
    .pf-label { font-size:.813rem; font-weight:600; color:var(--gray-700); display:flex; align-items:center; gap:.25rem; }
    .pf-label-required::after { content:'*'; color:var(--primary); margin-left:.25rem; }

    .pf .form-control, .pf .form-select, .pf-input, .pf-select {
        padding:.75rem 1rem !important; border:1.5px solid var(--gray-200) !important;
        border-radius:var(--radius-md) !important; font-size:.938rem !important;
        color:var(--gray-800) !important; background:white !important;
        transition:all .2s ease; width:100%; font-family:var(--font-sans) !important;
    }
    [data-theme="dark"] .pf .form-control, [data-theme="dark"] .pf .form-select,
    [data-theme="dark"] .pf-input { background:var(--gray-100) !important; color:var(--gray-800) !important; }
    .pf .form-control:focus, .pf .form-select:focus, .pf-input:focus {
        outline:none !important; border-color:var(--primary) !important; box-shadow:0 0 0 4px var(--primary-soft) !important;
    }
    .pf textarea.form-control { resize:vertical; min-height:80px; }

    .pf-hint { font-size:.75rem; color:var(--gray-500); display:flex; align-items:center; gap:.25rem; }
    .pf-error-message { font-size:.75rem; color:var(--error); display:flex; align-items:center; gap:.25rem; margin-top:.25rem; }

    /* Toggle */
    .pf-toggle {
        display:flex; align-items:center; gap:1rem; padding:1rem 1.25rem;
        background:var(--gray-50); border:1.5px solid var(--gray-200);
        border-radius:var(--radius-md); cursor:pointer; transition:all .2s ease;
    }
    [data-theme="dark"] .pf-toggle { background:var(--gray-100); }
    .pf-toggle:hover { border-color:var(--primary); background:var(--primary-soft); }
    .pf-toggle input[type="checkbox"] { position:absolute; opacity:0; width:0; height:0; }
    .pf-toggle-switch {
        width:44px; height:24px; background:var(--gray-300); border-radius:100px;
        position:relative; transition:all .2s ease; flex-shrink:0;
    }
    .pf-toggle-switch::after {
        content:''; position:absolute; top:2px; left:2px; width:20px; height:20px;
        background:white; border-radius:50%; transition:transform .2s ease; box-shadow:var(--shadow-sm);
    }
    .pf-toggle input[type="checkbox"]:checked + .pf-toggle-switch { background:var(--primary); }
    .pf-toggle input[type="checkbox"]:checked + .pf-toggle-switch::after { transform:translateX(20px); }
    .pf-toggle-content { flex:1; display:flex; flex-direction:column; gap:.25rem; }
    .pf-toggle-title { font-weight:600; color:var(--gray-800); }
    .pf-toggle-description { font-size:.813rem; color:var(--gray-500); }

    /* Payment methods */
    .pf-payment-methods { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:.75rem; margin-top:.5rem; }
    .pf-payment-method { position:relative; }
    .pf-payment-method input[type="radio"] { position:absolute; opacity:0; width:0; height:0; }
    .pf-payment-method label {
        display:flex; flex-direction:column; align-items:center; gap:.5rem; padding:1rem;
        background:var(--gray-50); border:1.5px solid var(--gray-200); border-radius:var(--radius-md);
        cursor:pointer; transition:all .2s ease; text-align:center;
    }
    [data-theme="dark"] .pf-payment-method label { background:var(--gray-100); }
    .pf-payment-method label i { font-size:1.5rem; color:var(--gray-600); transition:all .2s ease; }
    .pf-payment-method label span { font-weight:500; color:var(--gray-700); font-size:.9rem; }
    .pf-payment-method input[type="radio"]:checked + label { border-color:var(--primary); background:var(--primary-soft); }
    .pf-payment-method input[type="radio"]:checked + label i { color:var(--primary); transform:scale(1.1); }
    .pf-payment-method input[type="radio"]:checked + label span { color:var(--primary); font-weight:600; }

    /* ══ PANEL CUENTAS BANCARIAS ════════════════════════════ */
    #pfBancoPanel {
        margin-top:1.25rem; overflow:hidden;
        max-height:0; opacity:0;
        transition:max-height .4s ease, opacity .3s ease;
    }
    #pfBancoPanel.open { max-height:700px; opacity:1; }

    .pf-banco-label {
        font-size:.78rem; font-weight:700; text-transform:uppercase; letter-spacing:.06em;
        color:var(--gray-500); margin-bottom:.75rem; display:flex; align-items:center; gap:.4rem;
    }

    .pf-banco-grid {
        display:grid; grid-template-columns:repeat(auto-fill, minmax(145px,1fr)); gap:.75rem;
    }

    .pf-banco-card { position:relative; }
    .pf-banco-card input[type="radio"] { position:absolute; opacity:0; width:0; height:0; }
    .pf-banco-card label {
        display:flex; flex-direction:column; align-items:flex-start; gap:.3rem;
        padding:.9rem 1rem; background:var(--gray-50); border:1.5px solid var(--gray-200);
        border-radius:var(--radius-md); cursor:pointer; transition:all .2s ease; width:100%; min-height:82px;
    }
    [data-theme="dark"] .pf-banco-card label { background:var(--gray-100); }
    .pf-banco-card label:hover { border-color:var(--primary-light); background:var(--primary-soft); }
    .pf-banco-card-icon { font-size:1.2rem; color:var(--gray-400); transition:color .2s, transform .2s; }
    .pf-banco-card-entidad { font-size:.875rem; font-weight:600; color:var(--gray-800); line-height:1.2; }
    .pf-banco-card-titular { font-size:.71rem; color:var(--gray-500); line-height:1.3; }
    .pf-banco-card input[type="radio"]:checked + label {
        border-color:var(--primary); background:var(--primary-soft); box-shadow:0 0 0 3px rgba(37,99,235,.1);
    }
    .pf-banco-card input[type="radio"]:checked + label .pf-banco-card-icon { color:var(--primary); transform:scale(1.1); }
    .pf-banco-card input[type="radio"]:checked + label .pf-banco-card-entidad { color:var(--primary); }
    .pf-banco-card.otro label { border-style:dashed; }
    .pf-banco-card.otro input[type="radio"]:checked + label { border-style:solid; }

    /* Panel inputs nuevo banco */
    #pfOtroBancoInputs {
        margin-top:.75rem; overflow:hidden; max-height:0; opacity:0;
        transition:max-height .35s ease, opacity .25s ease;
    }
    #pfOtroBancoInputs.open { max-height:280px; opacity:1; }
    .pf-otro-box {
        background:var(--gray-50); border:1.5px solid var(--gray-200);
        border-radius:var(--radius-md); padding:1.25rem;
    }
    [data-theme="dark"] .pf-otro-box { background:var(--gray-100); }
    .pf-otro-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem; }
    @media(max-width:600px) { .pf-otro-grid { grid-template-columns:1fr; } }
    .pf-btn-save-banco {
        display:inline-flex; align-items:center; gap:.4rem;
        padding:.5rem 1rem; border-radius:var(--radius-sm);
        border:1.5px solid var(--primary); background:transparent;
        color:var(--primary); font-size:.813rem; font-weight:600;
        cursor:pointer; transition:all .2s ease; font-family:var(--font-sans);
    }
    .pf-btn-save-banco:hover { background:var(--primary); color:white; }
    .pf-btn-save-banco.ok { background:var(--success-light); border-color:var(--success); color:#065f46; pointer-events:none; }

    /* Carrera "Otros" */
    #pfCarreraOtroWrap {
        overflow:hidden; max-height:0; opacity:0;
        transition:max-height .3s ease, opacity .25s ease;
    }
    #pfCarreraOtroWrap.open { max-height:120px; opacity:1; margin-top:1rem; }

    /* Cuotas */
    #pfCuotas { transition:max-height .35s ease, opacity .3s ease; overflow:hidden; max-height:600px; opacity:1; }
    #pfCuotas.hidden { max-height:0; opacity:0; pointer-events:none; margin:0; }

    /* Total card */
    .pf-total-card {
        background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border-radius:var(--radius-lg); padding:1.5rem; color:white; margin-top:1rem;
        display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem;
    }
    .pf-total-label { font-size:.875rem; font-weight:500; opacity:.9; display:flex; align-items:center; gap:.5rem; }
    .pf-total-amount { font-size:2rem; font-weight:700; line-height:1.2; }
    .pf-total-amount small { font-size:1rem; font-weight:400; opacity:.8; margin-right:.25rem; }

    /* Search */
    .pf-search-container { position:relative; }
    .pf-search-results {
        position:absolute; top:100%; left:0; right:0; z-index:9999;
        background:white; border:1.5px solid var(--gray-200); border-radius:var(--radius-md);
        box-shadow:var(--shadow-lg); max-height:250px; overflow-y:auto; display:none; margin-top:.25rem;
    }
    .pf-section { position: relative; }
    .pf-search-container { position: relative; z-index: 9999; }
    [data-theme="dark"] .pf-search-results { background:var(--gray-50); }
    .pf-search-result { padding:.75rem 1rem; cursor:pointer; border-bottom:1px solid var(--gray-200); transition:background-color .2s; }
    .pf-search-result:last-child { border-bottom:none; }
    .pf-search-result:hover { background:var(--primary-soft); }
    .pf-search-result-name { font-weight:600; color:var(--gray-800); margin-bottom:.25rem; }
    .pf-search-result-details { font-size:.75rem; color:var(--gray-500); display:flex; align-items:center; gap:1rem; }

    /* Upload */
    .pf-image-upload {
        border:2px dashed var(--gray-300); border-radius:var(--radius-lg); padding:2rem;
        text-align:center; transition:all .2s ease; cursor:pointer; background:var(--gray-50);
    }
    .pf-image-upload:hover { border-color:var(--primary); background:var(--primary-soft); }
    .pf-image-upload i { font-size:2rem; color:var(--gray-400); margin-bottom:.5rem; }
    .pf-image-upload p { color:var(--gray-600); font-size:.875rem; margin:0; }
    .pf-image-upload small { color:var(--gray-500); font-size:.75rem; display:block; margin-top:.5rem; }
    .pf-preview { margin-top:1rem; border-radius:var(--radius-md); overflow:hidden; max-width:200px; border:1px solid var(--gray-200); }
    .pf-preview img { width:100%; height:auto; display:block; cursor:zoom-in; transition:transform .2s; }
    .pf-preview img:hover { transform:scale(1.02); }

    /* Actions */
    .pf-actions {
        display:flex; align-items:center; justify-content:flex-end; gap:1rem;
        padding:2rem; background:var(--gray-50); border-top:1px solid var(--gray-200);
    }
    [data-theme="dark"] .pf-actions { background:var(--gray-100); }
    .pf-btn {
        padding:.75rem 1.5rem; border-radius:var(--radius-md); font-weight:600; font-size:.875rem;
        display:inline-flex; align-items:center; gap:.5rem; cursor:pointer;
        transition:all .2s ease; border:none; text-decoration:none; font-family:var(--font-sans);
    }
    .pf-btn-primary { background:var(--primary); color:white; box-shadow:0 4px 6px -1px rgba(37,99,235,.2); }
    .pf-btn-primary:hover { background:var(--primary-dark); transform:translateY(-2px); color:white; }
    .pf-btn-secondary { background:white;
        color:var(--gray-700); border:1.5px solid var(--gray-200); }
    .pf-btn-secondary:hover { background:var(--gray-50); border-color:var(--gray-300); color:var(--gray-900); }
    [data-theme="dark"] .pf-btn-secondary { background:var(--gray-100); }
    .pf-header {
        background: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        padding: 1.5rem 2rem; border-bottom: 1px solid var(--gray-200);
        display: flex; align-items: center; justify-content: space-between;
    }
    [data-theme="dark"] .pf-header { background: var(--gray-50); }
    .pf-header-left { display: flex; align-items: center; gap: 1rem; }
    .pf-header-badge {
        background: var(--gray-100); padding: 0.5rem 1rem; border-radius: 100px;
        font-size: 0.75rem; font-weight: 600; color: var(--gray-600);
        display: flex; align-items: center; gap: 0.5rem;
    }
</style>

<div class="pf">
    <div class="pf-shell mt-5">
        <form method="post" enctype="multipart/form-data" id="pagoForm">
            {% csrf_token %}
            <input type="hidden" id="cuentaBancariaId" name="cuenta_bancaria_id" value="{{ cuenta_bancaria_actual|default:'' }}">
            <!-- Cabecera -->
            <div class="pf-header">
                <div class="pf-header-left">
                </div>
                <div class="pf-header-badge">
                    <i class="fas fa-shield-alt"></i>
                    <span>{{ titulo }}</span>
                </div>
            </div>
            <div class="pf-body">

                <!-- § 1 DATOS BÁSICOS -->
                <div class="pf-section">
                    <div class="pf-section-header">
                        <div class="pf-section-number">1</div>
                        <div><h2>Información básica</h2><p>Número de recibo y fecha del pago</p></div>
                    </div>
                    <div class="pf-grid pf-grid-2">
                        <div class="pf-field">
                            <label class="pf-label">Nº de Recibo</label>
                            {{ form.numero_recibo }}
                            <div class="pf-hint"><i class="bi bi-info-circle"></i> Opcional</div>
                            {% if form.numero_recibo.errors %}<div class="pf-error-message"><i class="bi bi-exclamation-circle"></i> {{ form.numero_recibo.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="pf-field">
                            <label class="pf-label pf-label-required">Fecha</label>
                            {{ form.fecha }}
                            {% if form.fecha.errors %}<div class="pf-error-message"><i class="bi bi-exclamation-circle"></i> {{ form.fecha.errors.0 }}</div>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- § 2 PAGADOR -->
                <div class="pf-section">
                    <div class="pf-section-header">
                        <div class="pf-section-number">2</div>
                        <div><h2>Datos del pagador</h2><p>Alumno inscripto o cliente externo</p></div>
                    </div>

                    <label class="pf-toggle">
                        {{ form.es_cliente_diferenciado }}
                        <span class="pf-toggle-switch"></span>
                        <span class="pf-toggle-content">
            <span class="pf-toggle-title">Cliente no regular</span>
            <span class="pf-toggle-description">El pago no corresponde a un alumno inscripto</span>
        </span>
                    </label>
                    <div id="camposAlumno" style="margin-top:1.5rem;">
                        <div class="pf-field">
                            <label class="pf-label pf-label-required">Alumno</label>
                            <div style="display:flex; gap:.6rem; align-items:flex-start;">
                                <div class="pf-search-container" style="flex:1;">
                                    <input type="text" id="alumnoSearch" class="pf-input" autocomplete="off"
                                           placeholder="Buscar por nombre, apellido o cédula…"
                                           value="{% if pago and pago.alumno %}{{ pago.alumno.nombre_completo }}{% endif %}">
                                    <div id="alumnoResults" class="pf-search-results"></div>
                                </div>
                                <a href="{% url 'crear_alumno' %}"
                                   target="_blank"
                                   title="Registrar nuevo alumno (abre en nueva pestaña)"
                                   style="
                   display:inline-flex; align-items:center; gap:.4rem;
                   padding:.72rem 1rem; border-radius:var(--radius-md);
                   background:var(--primary-soft); color:var(--primary);
                   border:1.5px solid var(--primary); font-size:.85rem;
                   font-weight:700; text-decoration:none; white-space:nowrap;
                   transition:all .2s ease; font-family:var(--font-sans);
                   flex-shrink:0;
               "
                                   onmouseover="this.style.background='var(--primary)';this.style.color='white';"
                                   onmouseout="this.style.background='var(--primary-soft)';this.style.color='var(--primary)';">
                                    <i class="bi bi-person-plus-fill"></i>
                                    Nuevo alumno
                                </a>
                            </div>
                            <div class="d-none">{{ form.alumno }}</div>
                            {% if form.alumno.errors %}<div class="pf-error-message"><i class="bi bi-exclamation-circle"></i> {{ form.alumno.errors.0 }}</div>{% endif %}
                        </div>
                    </div>

                    <div id="camposClienteDif" style="display:none; margin-top:1.5rem;">
                        <div class="pf-field">
                            <label class="pf-label pf-label-required">Nombre del Cliente</label>
                            {{ form.nombre_cliente }}
                            {% if form.nombre_cliente.errors %}<div class="pf-error-message"><i class="bi bi-exclamation-circle"></i> {{ form.nombre_cliente.errors.0 }}</div>{% endif %}
                        </div>
                    </div>

                    <div class="pf-grid pf-grid-2" style="margin-top:1.5rem;">
                        <div class="pf-field">
                            <label class="pf-label pf-label-required">Sede</label>
                            {{ form.sede }}
                            {% if form.sede.errors %}<div class="pf-error-message"><i class="bi bi-exclamation-circle"></i> {{ form.sede.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="pf-field">
                            <label class="pf-label">Carrera / Curso</label>
                            {{ form.carrera }}
                            <div class="pf-hint"><i class="bi bi-info-circle"></i> Incluye cursos — elegí "Otros" si no aparece en la lista</div>
                        </div>
                    </div>

                    <!-- Campo libre para "Otros" en carrera -->
                    <div id="pfCarreraOtroWrap">
                        <div class="pf-field">
                            <label class="pf-label">Especificar carrera o curso</label>
                            {{ form.carrera_otro }}
                            <div class="pf-hint"><i class="bi bi-pencil"></i> Ej: Inglés avanzado, Peluquería, Taller de cocina…</div>
                            {% if form.carrera_otro.errors %}<div class="pf-error-message"><i class="bi bi-exclamation-circle"></i> {{ form.carrera_otro.errors.0 }}</div>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- § 3 TIPO, METODO Y MONTO -->
                <div class="pf-section">
                    <div class="pf-section-header">
                        <div class="pf-section-number">3</div>
                        <div><h2>Tipo, método y monto</h2><p>Definí si es matrícula, cómo se abonó y el importe</p></div>
                    </div>

                    <!-- Toggle matrícula -->
                    <label class="pf-toggle" style="margin-bottom:1.5rem;">
                        {{ form.es_matricula }}
                        <span class="pf-toggle-switch"></span>
                        <span class="pf-toggle-content">
            <span class="pf-toggle-title">Matrícula / Concepto único</span>
            <span class="pf-toggle-description">Marcar si es matrícula o concepto no relacionado a cuotas mensuales</span>
        </span>
                    </label>

                    <!-- Metodo de pago -->
                    <div class="pf-field">
                        <label class="pf-label pf-label-required">Método de Pago</label>
                        <div class="pf-payment-methods">
                            {% for radio in form.metodo_pago %}
                            <div class="pf-payment-method">
                                <input type="radio" name="{{ radio.data.name }}" value="{{ radio.data.value }}"
                                       id="{{ radio.id_for_label }}" {% if radio.data.selected %}checked{% endif %}>
                                <label for="{{ radio.id_for_label }}">
                                    {% if radio.data.value == 'EFECTIVO' %}
                                    <i class="bi bi-cash-stack"></i>
                                    {% else %}
                                    <i class="bi bi-bank2"></i>
                                    {% endif %}
                                    <span>{{ radio.choice_label }}</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% if form.metodo_pago.errors %}<div class="pf-error-message"><i class="bi bi-exclamation-circle"></i> {{ form.metodo_pago.errors.0 }}</div>{% endif %}
                    </div>

                    <!-- PANEL CUENTAS BANCARIAS (aparece solo con Transferencia) -->
                    <div id="pfBancoPanel">
                        <div class="pf-banco-label">
                            <i class="bi bi-bank"></i> Cuenta destino de la transferencia
                        </div>
                        <div class="pf-banco-grid" id="pfBancoGrid">
                            <!-- Tarjetas de cuentas guardadas inyectadas por JS -->
                            <!-- Tarjeta "Otro banco" siempre visible -->
                            <div class="pf-banco-card otro" id="pfCardOtro">
                                <input type="radio" name="banco_seleccion" value="OTRO" id="pfRadioOtro">
                                <label for="pfRadioOtro">
                                    <span class="pf-banco-card-icon"><i class="bi bi-plus-circle-dotted"></i></span>
                                    <span class="pf-banco-card-entidad">Otro banco</span>
                                    <span class="pf-banco-card-titular">Ingresar manualmente</span>
                                </label>
                            </div>
                        </div>

                        <!-- Inputs para banco manual -->
                        <div id="pfOtroBancoInputs">
                            <div class="pf-otro-box">
                                <div class="pf-banco-label" style="margin-bottom:.75rem;"><i class="bi bi-pencil-square"></i> Datos de la cuenta</div>
                                <div class="pf-otro-grid">
                                    <div class="pf-field">
                                        <label class="pf-label pf-label-required">Entidad bancaria</label>
                                        <input type="text" id="pfEntidad" class="pf-input" placeholder="Ej: Banco Continental, Interfisa…">
                                    </div>
                                    <div class="pf-field">
                                        <label class="pf-label pf-label-required">Titular de la cuenta</label>
                                        <input type="text" id="pfTitular" class="pf-input" placeholder="Nombre completo del titular">
                                    </div>
                                </div>
                                <button type="button" class="pf-btn-save-banco" id="pfBtnSave">
                                    <i class="bi bi-floppy"></i> Guardar cuenta para futuros pagos
                                </button>
                                <div class="pf-hint" style="margin-top:.5rem;">
                                    <i class="bi bi-info-circle"></i>
                                    Si no la guardás se asocia solo a este pago; no aparecerá en futuros formularios.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cuotas -->
                    <div id="pfCuotas" style="margin-top:1.5rem;">
                        <div class="pf-grid pf-grid-3">
                            <div class="pf-field">
                                <label class="pf-label">Cuota Nº</label>
                                {{ form.numero_cuota }}
                                <div class="pf-hint"><i class="bi bi-info-circle"></i> Ej: 3 o 3,4,5</div>
                            </div>
                            <div class="pf-field">
                                <label class="pf-label">Cantidad</label>
                                {{ form.cantidad_cuotas }}
                            </div>
                            <div class="pf-field">
                                <label class="pf-label">Monto unitario (Gs.)</label>
                                {{ form.monto_unitario }}
                            </div>
                        </div>
                        <div class="pf-grid pf-grid-3" style="margin-top:1.5rem;">
                            <div class="pf-field">
                                <label class="pf-label">Vencimiento</label>
                                {{ form.fecha_vencimiento }}
                                <div class="pf-hint"><i class="bi bi-info-circle"></i> Para cálculo de puntos</div>
                            </div>
                            <div class="pf-field">
                                <label class="pf-label">Válido hasta</label>
                                {{ form.validez_pago }}
                            </div>
                            <div class="pf-field">
                                <label class="pf-label">Puntos ★</label>
                                {{ form.puntos }}
                                <div class="pf-hint"><i class="bi bi-info-circle"></i> Auto-calculado</div>
                            </div>
                        </div>
                    </div>

                    <!-- Importe total -->
                    <div class="pf-total-card">
                        <div>
                            <div class="pf-total-label"><i class="bi bi-cash-coin"></i> Total a cobrar</div>
                            <div class="pf-total-amount"><small>Gs.</small><span id="pfImporteDisplay">0</span></div>
                        </div>
                        <div class="pf-field" style="min-width:220px;">
                            {{ form.importe_total }}
                            {% if form.importe_total.errors %}<div class="pf-error-message" style="color:#fca5a5;"><i class="bi bi-exclamation-circle"></i> {{ form.importe_total.errors.0 }}</div>{% endif %}
                        </div>
                    </div>

                    <div class="pf-field" style="margin-top:1.5rem;">
                        <label class="pf-label pf-label-required">Concepto</label>
                        {{ form.concepto }}
                        {% if form.concepto.errors %}<div class="pf-error-message"><i class="bi bi-exclamation-circle"></i> {{ form.concepto.errors.0 }}</div>{% endif %}
                        <div class="pf-hint"><i class="bi bi-info-circle"></i> Descripción breve del motivo del pago</div>
                    </div>
                </div>

                <!-- § 4 COMPROBANTE -->
                <div class="pf-section">
                    <div class="pf-section-header">
                        <div class="pf-section-number">4</div>
                        <div><h2>Comprobante y observaciones</h2><p>Adjuntá foto si aplica</p></div>
                    </div>
                    <div class="pf-field">
                        <label class="pf-label">Foto del comprobante</label>
                        <div class="pf-image-upload" onclick="document.getElementById('id_foto_comprobante').click()">
                            <i class="bi bi-cloud-upload"></i>
                            <p>Hacé clic para subir una imagen</p>
                            <small>JPG, PNG o PDF (máx. 5 MB)</small>
                        </div>
                        <div style="display:none;">{{ form.foto_comprobante }}</div>
                        {% if pago and pago.foto_comprobante %}
                        <div class="pf-preview">
                            <img src="{{ pago.foto_comprobante.url }}" id="imagenPreview"
                                 onclick="abrirModalImg('{{ pago.foto_comprobante.url }}')" alt="Comprobante actual">
                            <div class="pf-hint" style="padding:.5rem;text-align:center;"><i class="bi bi-zoom-in"></i> Clic para ampliar</div>
                        </div>
                        {% else %}
                        <div class="pf-preview" id="previewContainer" style="display:none;">
                            <img src="" id="imagenPreview" alt="Vista previa">
                            <div class="pf-hint" style="padding:.5rem;text-align:center;"><i class="bi bi-eye"></i> Vista previa</div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="pf-field" style="margin-top:1.5rem;">
                        <label class="pf-label">Observaciones</label>
                        {{ form.observaciones }}
                        <div class="pf-hint"><i class="bi bi-info-circle"></i> Opcional</div>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="pf-actions">
                    <a href="{% url 'lista_caja' %}" class="pf-btn pf-btn-secondary"><i class="bi bi-x-lg"></i> Cancelar</a>
                    <button type="submit" class="pf-btn pf-btn-primary"><i class="bi bi-check-lg"></i> {{ boton }}</button>
                </div>

            </div>
        </form>
    </div>
</div>

<!-- Modal imagen -->
<div class="modal fade" id="modalImg" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0" style="background:transparent;">
            <div class="modal-header border-0" style="background:rgba(0,0,0,.9);color:white;">
                <h5 class="modal-title"><i class="bi bi-receipt"></i> Comprobante</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" style="background:rgba(0,0,0,.9);padding:2rem;">
                <img src="" id="imgModalGrande" style="max-width:100%;max-height:80vh;border-radius:8px;">
            </div>
        </div>
    </div>
</div>

<script>
    const carrerasData = JSON.parse('{{ carreras_data|escapejs }}');
    const CM = new Map(carrerasData.map(c => [String(c.id), c]));

    let cuentasBancarias = [];
    try { cuentasBancarias = JSON.parse('{{ cuentas_bancarias|default:"[]"|escapejs }}'); } catch(e) {}

    const $  = id => document.getElementById(id);
    const deb = (fn,ms) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

    /* ── Importe ─────────────────────────────────────── */
    function refreshImporte() {
        const v = parseFloat($('id_importe_total')?.value)||0;
        $('pfImporteDisplay').textContent = v>0 ? v.toLocaleString('es-PY') : '0';
    }
    function calcImporte() {
        if ($('id_es_matricula')?.checked) return;
        const mu=parseFloat($('id_monto_unitario')?.value)||0;
        const cant=parseInt($('id_cantidad_cuotas')?.value||'1',10)||1;
        if(mu>0){ $('id_importe_total').value=mu*cant; refreshImporte(); }
    }
    function applyCarrera(id) {
        const c=CM.get(String(id)); if(!c) return;
        const esM=$('id_es_matricula')?.checked;
        const mu=$('id_monto_unitario');
        if(mu){ mu.value=esM?c.monto_matricula:c.monto_mensualidad; calcImporte(); }
        if(!esM&&!$('id_concepto').value){
            const opt=$('id_carrera')?.options[$('id_carrera').selectedIndex];
            if(opt) $('id_concepto').value=`Pago de cuota - ${opt.text}`;
        }
    }

    /* ── Matrícula ───────────────────────────────────── */
    function syncMatricula() {
        const esM=$('id_es_matricula')?.checked;
        $('pfCuotas').classList.toggle('hidden',esM);
        if(esM){
            if($('id_numero_cuota')) $('id_numero_cuota').value='';
            if($('id_fecha_vencimiento')) $('id_fecha_vencimiento').value='';
            if($('id_puntos')) $('id_puntos').value='0';
            if($('id_cantidad_cuotas')) $('id_cantidad_cuotas').value='1';
            const cid=$('id_carrera')?.value;
            if(cid&&CM.has(cid)){
                const c=CM.get(cid);
                if($('id_monto_unitario')) $('id_monto_unitario').value=c.monto_matricula;
                if($('id_importe_total'))  $('id_importe_total').value=c.monto_matricula;
                if(!$('id_concepto').value) $('id_concepto').value='Pago de matrícula';
            }
        } else {
            const cid=$('id_carrera')?.value;
            if(cid&&CM.has(cid)) applyCarrera(cid);
        }
        refreshImporte();
    }

    /* ── Cliente ─────────────────────────────────────── */
    function syncCliente() {
        const on=$('id_es_cliente_diferenciado')?.checked;
        $('camposAlumno').style.display=on?'none':'block';
        $('camposClienteDif').style.display=on?'block':'none';
        if(on){ if($('id_alumno')) $('id_alumno').value=''; if($('alumnoSearch')) $('alumnoSearch').value=''; }
    }

    /* ── Carrera "Otros" ─────────────────────────────── */
    function syncCarrera() {
        const sel=$('id_carrera'); const wrap=$('pfCarreraOtroWrap'); if(!sel||!wrap) return;
        const idx=sel.selectedIndex;
        const txt=idx>=0 ? sel.options[idx].text.trim().toUpperCase() : '';
        const val=sel.value;
        const esOtros=(val==='OTROS'||txt==='OTROS');
        wrap.classList.toggle('open',esOtros);
        if(!esOtros&&$('id_carrera_otro')) $('id_carrera_otro').value='';
    }

    /* ── Metodo de pago → banco ──────────────────────── */
    function syncMetodoPago() {
        let metodo='';
        document.querySelectorAll('input[name="metodo_pago"]').forEach(r=>{ if(r.checked) metodo=r.value; });
        const panel=$('pfBancoPanel');
        const esT=(metodo==='TRANSFERENCIA');
        panel.classList.toggle('open',esT);
        if(!esT){ $('cuentaBancariaId').value=''; document.querySelectorAll('input[name="banco_seleccion"]').forEach(r=>r.checked=false); cerrarOtro(); }
    }

    /* ── Tarjetas de banco ───────────────────────────── */
    const ICONOS={ continental:'bi-bank',itau:'bi-building-fill',vision:'bi-eye-fill',familiar:'bi-house-heart-fill',bnf:'bi-flag-fill',interfisa:'bi-diagram-3-fill',rio:'bi-water',basa:'bi-bar-chart-fill',atlas:'bi-globe2' };

    function renderBancos(cuentas) {
        const grid=$('pfBancoGrid'); const cardOtro=$('pfCardOtro'); if(!grid) return;
        grid.querySelectorAll('.pf-banco-card:not(.otro)').forEach(el=>el.remove());
        const actualId=$('cuentaBancariaId')?.value;
        cuentas.forEach(c=>{
            const card=document.createElement('div');
            card.className='pf-banco-card';
            const iid=`pfBanco_${c.id}`;
            const key=Object.keys(ICONOS).find(k=>c.entidad.toLowerCase().includes(k));
            const icon=ICONOS[key]||'bi-bank';
            card.innerHTML=`
            <input type="radio" name="banco_seleccion" value="${c.id}" id="${iid}" ${actualId==c.id?'checked':''}>
            <label for="${iid}">
                <span class="pf-banco-card-icon"><i class="bi ${icon}"></i></span>
                <span class="pf-banco-card-entidad">${c.entidad}</span>
                <span class="pf-banco-card-titular">${c.titular}</span>
            </label>`;
            card.querySelector('input').addEventListener('change',()=>{ $('cuentaBancariaId').value=c.id; cerrarOtro(); });
            grid.insertBefore(card,cardOtro);
            if(actualId==c.id) $('cuentaBancariaId').value=c.id;
        });
        $('pfRadioOtro').addEventListener('change',()=>{ $('cuentaBancariaId').value=''; $('pfOtroBancoInputs').classList.add('open'); });
    }

    function cerrarOtro(){ $('pfOtroBancoInputs')?.classList.remove('open'); }

    async function guardarBanco() {
        const ent=$('pfEntidad')?.value.trim(); const tit=$('pfTitular')?.value.trim();
        if(!ent||!tit){ alert('Ingresá entidad y titular para guardar.'); return; }
        const btn=$('pfBtnSave');
        btn.disabled=true; btn.innerHTML='<i class="bi bi-hourglass-split"></i> Guardando…';
        try {
            const res=await fetch('/cuentas-bancarias/',{
                method:'POST',
                headers:{'Content-Type':'application/json','X-CSRFToken':document.querySelector('[name=csrfmiddlewaretoken]').value},
                body:JSON.stringify({entidad:ent,titular:tit})
            });
            const d=await res.json();
            if(!d.id) throw new Error(d.error||'Error');
            $('cuentaBancariaId').value=d.id;
            if(!cuentasBancarias.find(c=>c.id===d.id)) cuentasBancarias.push(d);
            renderBancos(cuentasBancarias);
            const r=document.querySelector(`input[name="banco_seleccion"][value="${d.id}"]`);
            if(r){ r.checked=true; $('cuentaBancariaId').value=d.id; }
            cerrarOtro();
            btn.className='pf-btn-save-banco ok'; btn.innerHTML='<i class="bi bi-check-circle-fill"></i> Guardado';
        } catch(err){
            alert('No se pudo guardar: '+err.message);
            btn.disabled=false; btn.innerHTML='<i class="bi bi-floppy"></i> Guardar cuenta para futuros pagos';
        }
    }

    /* ── Búsqueda alumnos ────────────────────────────── */
    async function buscar(q){ try{ const r=await fetch(`/buscar-alumno/?q=${encodeURIComponent(q)}`); return (await r.json()).resultados||[]; }catch{ return[]; } }

    function renderResultados(data){
        const box=$('alumnoResults'); box.innerHTML='';
        if(!data.length){ box.style.display='none'; return; }
        data.forEach(a=>{
            const item=document.createElement('div'); item.className='pf-search-result';
            item.innerHTML=`<div class="pf-search-result-name">${a.nombre_completo}</div>
            <div class="pf-search-result-details"><span><i class="bi bi-person-badge"></i> ${a.cedula||'Sin cédula'}</span><span><i class="bi bi-building"></i> ${a.carrera||'Sin carrera'}</span></div>`;
            item.addEventListener('click',()=>{
                $('id_alumno').value=a.id;
                $('alumnoSearch').value=`${a.nombre_completo} (${a.cedula||'Sin cédula'})`;
                if(a.sede_id) $('id_sede').value=a.sede_id;
                if(a.carrera_id){ $('id_carrera').value=a.carrera_id; applyCarrera(a.carrera_id); syncCarrera(); }
                box.style.display='none';
                $('alumnoSearch').style.borderColor='var(--success)';
                setTimeout(()=>$('alumnoSearch').style.borderColor='',600);
            });
            box.appendChild(item);
        });
        box.style.display='block';
    }

    function abrirModalImg(url){ $('imgModalGrande').src=url; new bootstrap.Modal($('modalImg')).show(); }

    /* ── Init ────────────────────────────────────────── */
    document.addEventListener('DOMContentLoaded',()=>{
        syncCliente(); syncMatricula(); syncMetodoPago(); syncCarrera(); refreshImporte();
        renderBancos(cuentasBancarias);

        $('id_es_matricula')?.addEventListener('change',syncMatricula);
        $('id_es_cliente_diferenciado')?.addEventListener('change',syncCliente);
        $('id_carrera')?.addEventListener('change',()=>{ applyCarrera($('id_carrera').value); syncCarrera(); });
        document.querySelectorAll('input[name="metodo_pago"]').forEach(r=>r.addEventListener('change',syncMetodoPago));
        $('pfBtnSave')?.addEventListener('click',guardarBanco);
        $('id_monto_unitario')?.addEventListener('input',calcImporte);
        $('id_cantidad_cuotas')?.addEventListener('input',calcImporte);
        $('id_importe_total')?.addEventListener('input',refreshImporte);

        $('alumnoSearch')?.addEventListener('input',deb(async e=>{
            const q=e.target.value.trim(); if(q.length<2){ renderResultados([]); return; }
            renderResultados(await buscar(q));
        },300));
        document.addEventListener('click',e=>{ if(!e.target.closest('.pf-search-container')) $('alumnoResults').style.display='none'; });

        const p=new URLSearchParams(location.search);
        if(p.get('alumno')&&$('id_alumno')) $('id_alumno').value=p.get('alumno');
        if(p.get('nombre')&&$('alumnoSearch')) $('alumnoSearch').value=decodeURIComponent(p.get('nombre'));
        if(p.get('sede')&&$('id_sede')) $('id_sede').value=p.get('sede');
        if(p.get('carrera')&&$('id_carrera')){ $('id_carrera').value=p.get('carrera'); applyCarrera(p.get('carrera')); syncCarrera(); }

        $('id_foto_comprobante')?.addEventListener('change',e=>{
            const f=e.target.files[0]; if(!f) return;
            const r=new FileReader(); r.onload=ev=>{ const img=$('imagenPreview'),cont=$('previewContainer'); if(img) img.src=ev.target.result; if(cont) cont.style.display='block'; }; r.readAsDataURL(f);
        });

        $('pagoForm')?.addEventListener('submit',e=>{
            const v=parseFloat($('id_importe_total')?.value);
            if(!v||v<=0){ e.preventDefault(); $('id_importe_total')?.focus(); alert('El importe debe ser mayor a 0.'); return; }
            let metodo='';
            document.querySelectorAll('input[name="metodo_pago"]').forEach(r=>{ if(r.checked) metodo=r.value; });
            if(metodo==='TRANSFERENCIA'){
                const br=document.querySelector('input[name="banco_seleccion"]:checked');
                if(!br){ e.preventDefault(); alert('Seleccioná la cuenta bancaria destino.'); return; }
                if(br.value==='OTRO'){
                    const ent=$('pfEntidad')?.value.trim(), tit=$('pfTitular')?.value.trim();
                    if(!ent||!tit){ e.preventDefault(); alert('Completá entidad y titular del banco.'); return; }
                    const f=$('pagoForm');
                    let h1=document.createElement('input'); h1.type='hidden'; h1.name='otro_banco_entidad'; h1.value=ent; f.appendChild(h1);
                    let h2=document.createElement('input'); h2.type='hidden'; h2.name='otro_banco_titular'; h2.value=tit; f.appendChild(h2);
                }
            }
        });
    });
</script>
{% endblock %}