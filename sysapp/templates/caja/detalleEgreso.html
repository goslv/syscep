{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Detalle de Egreso - {{ egreso.numero_comprobante }}{% endblock %}
{% block page_title %}Detalle de Egreso{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap');

    :root {
        --ink: #0f172a;
        --muted: #64748b;
        --line: rgba(148, 163, 184, 0.25);
        --danger: #ef4444;
        --card-bg: #ffffff;
        --border-color: rgba(148, 163, 184, 0.2);
    }

    [data-theme="dark"] {
        --ink: #f8fafc;
        --muted: #94a3b8;
        --line: rgba(255, 255, 255, 0.1);
        --card-bg: #1e293b;
        --border-color: #334155;
    }

    .detail-card {
        background: var(--card-bg);
        border-radius: 18px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--border-color);
        font-family: 'IBM Plex Sans', sans-serif;
        margin-bottom: 1.5rem;
    }

    .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--danger);
    }

    .detail-item {
        margin-bottom: 1.25rem;
    }

    .detail-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .detail-value {
        color: var(--ink);
        font-size: 1.1rem;
    }

    .comprobante-container {
        position: sticky;
        top: 2rem;
    }

    .comprobante-img {
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .comprobante-img:hover {
        transform: scale(1.02);
    }

    .numero-badge {
        background-color: var(--danger);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-action {
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-action:hover {
        transform: translateY(-2px);
    }

    .btn-back {
        background-color: var(--line);
        color: var(--ink);
        margin-bottom: 1.5rem;
    }

    .btn-edit { background-color: #f59e0b; color: white; }
    .btn-delete { background-color: #ef4444; color: white; }

    [data-theme="dark"] .btn-back { background-color: #334155; }
    /* Modal de Imagen Modernizado */
    .modal-fullscreen-custom {
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(8px);
    }

    .modal-image-container {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        padding: 2rem;
    }

    .modal-image-content {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        transition: transform 0.3s ease;
        cursor: zoom-in;
    }

    .modal-image-content.zoomed {
        transform: scale(1.5);
        cursor: zoom-out;
    }

    .modal-close-btn {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 1060;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }

    .modal-download-btn {
        position: absolute;
        bottom: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1060;
        background: rgba(190, 18, 60, 0.84);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.4);
    }

    .modal-download-btn:hover {
        background: rgba(190, 18, 60, 0.45);
        color: white;
        transform: translateX(-50%) translateY(-2px);
    }

    [data-theme="dark"] .detail-value.text-muted {
        color: var(--muted) !important;
    }
</style>

<div class="container-fluid mt-5">
    {% if user.is_staff %}
    <a href="{% url 'lista_egresos' %}" class="btn-action btn-back no-print">
        <i class="bi bi-arrow-left"></i> Volver a Egresos
    </a>
    {% else %}
    <a href="{% url 'lista_caja' %}" class="btn-action btn-back no-print">
        <i class="bi bi-arrow-left"></i> Volver a Caja
    </a>
    {% endif %}

    <div class="row">
        {% if egreso.comprobante %}
        <div class="col-md-5 mb-4">
            <div class="comprobante-container">
                <img src="{{ egreso.comprobante.url }}"
                     alt="Comprobante de egreso"
                     class="comprobante-img"
                     onclick="abrirModalImagen('{{ egreso.comprobante.url }}')">
                <div class="mt-3 text-center no-print">
                    <a href="{{ egreso.comprobante.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i> Ver original
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="{% if egreso.comprobante %}col-md-7{% else %}col-md-10 mx-auto{% endif %}">
            <div class="detail-card">
                <div class="detail-header">
                    <div class="numero-badge">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="action-buttons d-flex gap-2 no-print">
                        <a href="{% url 'editar_egreso' egreso.id %}" class="btn-action btn-edit" title="Editar">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <button type="button" class="btn-action btn-delete" onclick="confirmarAccionEliminar()" title="{% if user.is_staff %}Eliminar{% else %}Solicitar Eliminación{% endif %}">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-calendar-event"></i> Fecha</div>
                            <div class="detail-value">{{ egreso.fecha|date:"d/m/Y" }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-building"></i> Sede</div>
                            <div class="detail-value">{{ egreso.sede.nombre }}</div>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-tag-fill"></i> Categoría</div>
                            <div class="detail-value">
                                <span class="badge bg-info text-dark">{{ egreso.get_categoria_display }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-card-text"></i> Concepto</div>
                            <div class="detail-value">{{ egreso.concepto }}</div>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-cash-stack"></i> Monto del Egreso</div>
                            <div class="detail-value">
                                <strong class="text-danger" style="font-size: 1.5rem;">Gs. {{ egreso.monto|formato_guaranies }}</strong>
                            </div>
                        </div>
                    </div>

                    {% if egreso.observaciones %}
                    <div class="col-md-12">
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-chat-dots"></i> Observaciones</div>
                            <div class="detail-value text-muted">{{ egreso.observaciones|linebreaks }}</div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="col-md-12 mt-3 pt-3 border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="detail-item mb-0">
                                    <div class="detail-label"><i class="bi bi-person-check"></i> Registrado por</div>
                                    <div class="detail-value small">
                                        {{ egreso.usuario_registro.get_full_name|default:egreso.usuario_registro.username }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item mb-0 text-md-end">
                                    <div class="detail-label justify-content-md-end"><i class="bi bi-clock"></i> Fecha Registro</div>
                                    <div class="detail-value small">{{ egreso.fecha_creacion|date:"d/m/Y H:i" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar imagen modernizado -->
<div class="modal fade modal-fullscreen-custom" id="modalImagen" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen m-0">
        <div class="modal-content bg-transparent border-0">
            <button type="button" class="modal-close-btn" data-bs-dismiss="modal" aria-label="Close">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="modal-image-container" onclick="toggleZoom(event)">
                <img src="" id="imagenModal" alt="Comprobante" class="modal-image-content">
                
                <a href="" id="btnDescargarImagen" download class="modal-download-btn no-print">
                    <i class="bi bi-cloud-arrow-down"></i> Descargar Comprobante
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar/solicitar -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header {% if user.is_staff %}bg-danger{% else %}bg-warning{% endif %} text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> {% if user.is_staff %}Confirmar Eliminación{% else %}Solicitar Eliminación{% endif %}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if user.is_staff %}
                    <p>¿Está seguro de que desea eliminar este egreso?</p>
                    <div class="alert alert-warning small">
                        <strong>N°:</strong> {{ egreso.numero_comprobante }}<br>
                        <strong>Monto:</strong> Gs. {{ egreso.monto|formato_guaranies }}<br>
                        <strong>Concepto:</strong> {{ egreso.concepto|truncatewords:10 }}
                    </div>
                    <p class="text-danger mb-0"><i class="bi bi-info-circle"></i> Esta acción no se puede deshacer.</p>
                {% else %}
                    <p>Para eliminar este egreso, debes enviar una solicitud al administrador detallando el motivo.</p>
                {% endif %}

                <form action="{% url 'eliminar_egreso' egreso.id %}" method="post" class="mt-3">
                    {% csrf_token %}
                    {% if not user.is_staff %}
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Motivo de la eliminación</label>
                        <textarea name="motivo" class="form-control" rows="3" placeholder="Explica por qué es necesario eliminar este egreso..." required></textarea>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn {% if user.is_staff %}btn-danger{% else %}btn-warning{% endif %} px-4">
                            <i class="bi bi-trash"></i> {% if user.is_staff %}Sí, Eliminar{% else %}Enviar Solicitud{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmarAccionEliminar() {
    new bootstrap.Modal(document.getElementById('modalEliminar')).show();
}
function abrirModalImagen(url) {
    const img = document.getElementById('imagenModal');
    const downloadBtn = document.getElementById('btnDescargarImagen');
    
    img.src = url;
    img.classList.remove('zoomed');
    downloadBtn.href = url;
    
    new bootstrap.Modal(document.getElementById('modalImagen')).show();
}

function toggleZoom(event) {
    if (event.target.closest('.modal-download-btn')) return;
    const img = document.getElementById('imagenModal');
    const downloadBtn = document.getElementById('btnDescargarImagen');
    const ZOOM_SCALE = 1.5;

    const isZoomed = img.classList.toggle('zoomed');

    if (downloadBtn) downloadBtn.style.display = isZoomed ? 'none' : '';

    if (isZoomed) {
        enablePan(img, ZOOM_SCALE);
    } else {
        disablePan(img);
    }

    function enablePan(target, scale) {
        target.dataset.tx = target.dataset.tx || '0';
        target.dataset.ty = target.dataset.ty || '0';
        let startX = 0, startY = 0;
        let startTx = parseFloat(target.dataset.tx);
        let startTy = parseFloat(target.dataset.ty);
        let dragging = false;

        target.style.transform = `scale(${scale}) translate(${startTx}px, ${startTy}px)`;
        target.style.cursor = 'grab';
        target.style.touchAction = 'none';

        function onPointerDown(e) {
            e.preventDefault();
            dragging = true;
            try { target.setPointerCapture(e.pointerId); } catch (err) {}
            startX = e.clientX;
            startY = e.clientY;
            startTx = parseFloat(target.dataset.tx) || 0;
            startTy = parseFloat(target.dataset.ty) || 0;
            target.style.cursor = 'grabbing';
        }
        function onPointerMove(e) {
            if (!dragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            const tx = startTx + dx;
            const ty = startTy + dy;
            target.dataset.tx = tx;
            target.dataset.ty = ty;
            target.style.transform = `scale(${scale}) translate(${tx}px, ${ty}px)`;
        }
        function onPointerUp(e) {
            if (!dragging) return;
            dragging = false;
            try { target.releasePointerCapture(e.pointerId); } catch (err) {}
            target.style.cursor = 'grab';
        }

        target.__panHandlers = { onPointerDown, onPointerMove, onPointerUp };
        target.addEventListener('pointerdown', onPointerDown);
        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);
        window.addEventListener('pointercancel', onPointerUp);
    }

    function disablePan(target) {
        const t = target || document.getElementById('imagenModal');
        const h = t.__panHandlers || {};
        if (h.onPointerDown) t.removeEventListener('pointerdown', h.onPointerDown);
        if (h.onPointerMove) window.removeEventListener('pointermove', h.onPointerMove);
        if (h.onPointerUp) {
            window.removeEventListener('pointerup', h.onPointerUp);
            window.removeEventListener('pointercancel', h.onPointerUp);
        }
        t.__panHandlers = null;
        t.style.cursor = '';
        t.style.touchAction = '';
        t.dataset.tx = '0';
        t.dataset.ty = '0';
        t.style.transform = '';
    }
}
</script>
{% endblock %}